{% extends 'base.html' %}
{% block title %}Comanda {{ comanda.codigo }}{% endblock %}
{% block content %}
{% if current_user.is_authenticated %}
  <a class="btn" href="{{ url_for('main.nova_comanda') }}">Nova Comanda</a>
{% endif %}

  <h2>Comanda #{{ comanda.codigo }} — {{ comanda.status|capitalize }}</h2>

  <div class="meta">
    <small>Criada: {{ comanda.created_at }} {% if comanda.created_by %}por: {{ comanda.created_by }}{% endif %}</small>
    {% if comanda.closed_at %}<small> | Fechada: {{ comanda.closed_at }} {% if comanda.closed_by %}por: {{ comanda.closed_by }}{% endif %}</small>{% endif %}
    {% if comanda.paid_at %}<small> | Pago: {{ comanda.paid_at }} {% if comanda.paid_by %}por: {{ comanda.paid_by }}{% endif %}</small>{% endif %}
  </div>

  <section class="itens">
    <h3>Itens da Comanda</h3>
    {% if comanda.itens|length == 0 %}
      <p>Sem itens.</p>
    {% else %}
      <table class="table">
        <thead><tr><th>Item</th><th>Qnt</th><th>Unit</th><th>Subtotal</th><th></th></tr></thead>
        <tbody>
          {% for ic in comanda.itens %}
            <tr>
              <td>{{ ic.item.nome }}</td>
              <td>{{ ic.quantidade }}</td>
              <td>R$ {{ '%.2f'|format(ic.preco_unitario) }}</td>
              <td>R$ {{ '%.2f'|format(ic.total) }}</td>
              <td>
                {% if comanda.status == 'aberta' or current_user.is_admin() %}
                  <form method="POST" action="{{ url_for('main.remover_item', codigo=comanda.codigo, itemcomanda_id=ic.id) }}">
                    <button class="btn small danger" type="submit">Remover</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
    <p class="total"><strong>Total:</strong> R$ {{ '%.2f'|format(total) }}</p>
  </section>

  <section class="adicionar">
    <h3>Adicionar Item</h3>
    {% if comanda.status != 'aberta' and not current_user.is_admin() %}
      <p>Edição não permitida (comanda não está aberta).</p>
    {% else %}
      <form method="POST" action="{{ url_for('main.adicionar_item', codigo=comanda.codigo) }}">
        <label for="item_id">Item</label>
        <select id="item_id" name="item_id">
          {% for item in itens_disponiveis %}
            <option value="{{ item.id }}">{{ item.nome }} — R$ {{ '%.2f'|format(item.preco) }}</option>
          {% endfor %}
        </select>
        <label for="quantidade">Quantidade</label>
        <input type="number" name="quantidade" id="quantidade" value="1" min="1">
        <button class="btn" type="submit">Adicionar</button>
      </form>
    {% endif %}
  </section>

  <section class="acoes">
    {% if comanda.status == 'aberta' and (current_user.is_atendente() or current_user.is_admin()) %}
      <form method="POST" action="{{ url_for('main.fechar_comanda', codigo=comanda.codigo) }}" style="display:inline">
        <button class="btn primary" type="submit">Fechar Comanda</button>
      </form>
    {% endif %}

    {% if comanda.status == 'fechada' and current_user.is_admin() %}
      <div class="pagamento">
        <h4>Registrar Pagamento</h4>
        <form method="POST" action="{{ url_for('admin.pagar_comanda', codigo=comanda.codigo) }}">
          <label>Forma</label>
          <select name="forma">
            <option value="dinheiro">Dinheiro</option>
            <option value="cartao">Cartão</option>
          </select>
          <label>Valor recebido</label>
          <input type="number" step="0.01" name="valor_recebido" required>
          <button class="btn success" type="submit">Registrar Pagamento</button>
        </form>
      </div>
    {% endif %}

    {% if comanda.status == 'paga' %}
      <p>Comprovante: Pago em {{ comanda.paid_at }} por {{ comanda.paid_by }}</p>
    {% endif %}
  </section>
{% endblock %}
